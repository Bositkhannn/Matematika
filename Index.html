<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>MathClass â€” O'quv Platformasi</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg: #0f172a;
  --bg2: #1e293b;
  --surface: #1e2d45;
  --surface2: #243450;
  --border: #2d4a6e;
  --accent: #38bdf8;
  --accent2: #0ea5e9;
  --accentT: rgba(56,189,248,0.15);
  --green: #22d3a0;
  --red: #f87171;
  --yellow: #fbbf24;
  --text: #e2e8f0;
  --muted: #64748b;
  --muted2: #94a3b8;
  --radius: 16px;
  --shadow: 0 8px 32px rgba(0,0,0,0.3);
  --font: 'Nunito', sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

[data-theme="ocean"] {
  --bg: #0a1628; --bg2: #0f2040; --surface: #122447; --surface2: #163060;
  --border: #1e4080; --accent: #22d3ee; --accent2: #06b6d4; --accentT: rgba(34,211,238,0.15);
}
[data-theme="forest"] {
  --bg: #0a1a0e; --bg2: #0f2915; --surface: #133519; --surface2: #174020;
  --border: #235c2c; --accent: #4ade80; --accent2: #22c55e; --accentT: rgba(74,222,128,0.15);
  --green: #86efac;
}
[data-theme="sunset"] {
  --bg: #1a0a0a; --bg2: #2a1010; --surface: #3a1515; --surface2: #451a1a;
  --border: #6b2525; --accent: #fb923c; --accent2: #f97316; --accentT: rgba(251,146,60,0.15);
  --green: #fb923c;
}
[data-theme="lavender"] {
  --bg: #0d0b1e; --bg2: #15122e; --surface: #1c1840; --surface2: #231f50;
  --border: #352f7a; --accent: #a78bfa; --accent2: #8b5cf6; --accentT: rgba(167,139,250,0.15);
  --green: #c4b5fd;
}
[data-theme="light"] {
  --bg: #f0f4ff; --bg2: #e8eeff; --surface: #ffffff; --surface2: #f0f4ff;
  --border: #c7d7f0; --accent: #3b82f6; --accent2: #2563eb; --accentT: rgba(59,130,246,0.12);
  --green: #059669; --red: #dc2626; --yellow: #d97706;
  --text: #1e293b; --muted: #64748b; --muted2: #475569;
  --shadow: 0 4px 20px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body { 
  background: var(--bg); color: var(--text); font-family: var(--font);
  min-height: 100vh; font-size: 16px; line-height: 1.5;
  transition: background .3s, color .3s;
}

/* â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â• */
.screen { display: none; min-height: 100vh; flex-direction: column; }
.screen.active { display: flex; }
.centered { align-items: center; justify-content: center; }

/* â•â•â•â•â•â•â• SCROLLBAR â•â•â•â•â•â•â• */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

/* â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â• */
#screen-landing {
  background: radial-gradient(ellipse at 30% 20%, var(--surface) 0%, var(--bg) 60%),
              radial-gradient(ellipse at 80% 80%, var(--bg2) 0%, transparent 50%);
  padding: 2rem 1.5rem; align-items: center; justify-content: center; text-align: center; gap: 2rem;
}
.landing-emoji { font-size: 4rem; animation: bounce 2s infinite; }
@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-12px)} }
.landing-title { font-size: clamp(2rem, 6vw, 3.5rem); font-weight: 900; letter-spacing: -1px; }
.landing-title span { color: var(--accent); }
.landing-subtitle { color: var(--muted2); font-size: 1rem; max-width: 320px; }
.landing-btns { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 320px; }
.theme-row { display: flex; gap: .5rem; flex-wrap: wrap; justify-content: center; margin-top: .5rem; }
.theme-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all .2s; }
.theme-dot.active { border-color: var(--text); transform: scale(1.2); }
.theme-dot[data-t="default"] { background: linear-gradient(135deg, #1e2d45, #38bdf8); }
.theme-dot[data-t="ocean"] { background: linear-gradient(135deg, #0a1628, #22d3ee); }
.theme-dot[data-t="forest"] { background: linear-gradient(135deg, #0a1a0e, #4ade80); }
.theme-dot[data-t="sunset"] { background: linear-gradient(135deg, #1a0a0a, #fb923c); }
.theme-dot[data-t="lavender"] { background: linear-gradient(135deg, #0d0b1e, #a78bfa); }
.theme-dot[data-t="light"] { background: linear-gradient(135deg, #e8eeff, #3b82f6); }

/* â•â•â•â•â•â•â• FORMS â•â•â•â•â•â•â• */
.form-wrap { align-items: center; justify-content: center; padding: 1.5rem;
  background: radial-gradient(ellipse at 50% 0%, var(--surface) 0%, var(--bg) 70%); }
.form-box { background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
  padding: 2rem; width: 100%; max-width: 400px; box-shadow: var(--shadow); }
.form-icon { font-size: 2.5rem; margin-bottom: .5rem; }
.form-title { font-size: 1.6rem; font-weight: 900; margin-bottom: .25rem; }
.form-sub { color: var(--muted2); font-size: .9rem; margin-bottom: 1.5rem; }

/* â•â•â•â•â•â•â• INPUTS â•â•â•â•â•â•â• */
.field { margin-bottom: 1rem; }
.field label { display: block; font-size: .8rem; font-weight: 700; color: var(--muted2); 
  text-transform: uppercase; letter-spacing: .06em; margin-bottom: .4rem; }
input[type=text], input[type=password], input[type=number], input[type=email], textarea, select {
  width: 100%; background: var(--bg2); border: 2px solid var(--border); border-radius: 12px;
  color: var(--text); font-family: var(--font); font-size: 1rem; padding: .75rem 1rem;
  outline: none; transition: border-color .2s, box-shadow .2s; appearance: none;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--accent); box-shadow: 0 0 0 4px var(--accentT);
}
textarea { resize: vertical; min-height: 80px; }
select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; padding-right: 2.5rem; }

/* â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
  padding: .75rem 1.4rem; border-radius: 12px; font-family: var(--font);
  font-weight: 800; font-size: .95rem; cursor: pointer; border: none;
  transition: all .2s; text-decoration: none; white-space: nowrap; user-select: none;
}
.btn:active { transform: scale(.96); }
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: rgba(248,113,113,.15); color: var(--red); border: 1px solid rgba(248,113,113,.3); }
.btn-danger:hover { background: rgba(248,113,113,.25); }
.btn-success { background: rgba(34,211,160,.15); color: var(--green); border: 1px solid rgba(34,211,160,.3); }
.btn-sm { padding: .45rem .9rem; font-size: .82rem; border-radius: 8px; }
.btn-lg { padding: 1rem 2rem; font-size: 1.05rem; border-radius: 14px; }
.btn-full { width: 100%; }
.btn-icon { padding: .5rem; border-radius: 8px; width: 36px; height: 36px; }

/* â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â• */
.navbar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: .8rem 1rem; display: flex; align-items: center; gap: .75rem;
  position: sticky; top: 0; z-index: 50;
}
.navbar-brand { font-weight: 900; font-size: 1.1rem; color: var(--accent); flex: 1; }
.navbar-user { font-size: .8rem; color: var(--muted2); font-weight: 700; }

/* â•â•â•â•â•â•â• BOTTOM NAV (Mobile) â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 50;
  background: var(--surface); border-top: 1px solid var(--border);
  display: flex; padding: .5rem .25rem calc(.5rem + env(safe-area-inset-bottom));
}
.bnav-item { flex: 1; display: flex; flex-direction: column; align-items: center;
  gap: .2rem; cursor: pointer; padding: .4rem; border-radius: 10px;
  color: var(--muted); font-size: .65rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: .04em; transition: all .2s; }
.bnav-item.active { color: var(--accent); }
.bnav-item .bnav-icon { font-size: 1.3rem; transition: transform .2s; }
.bnav-item.active .bnav-icon { transform: scale(1.15); }

/* â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â• */
.main { flex: 1; padding: 1rem; padding-bottom: 5rem; overflow-y: auto; }
.section { display: none; }
.section.active { display: block; }

/* â•â•â•â•â•â•â• CARDS â•â•â•â•â•â•â• */
.card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 1.2rem; margin-bottom: .85rem; transition: border-color .2s;
}
.card:hover { border-color: var(--accent); }
.card-title { font-size: 1rem; font-weight: 800; margin-bottom: .25rem; }
.card-meta { font-size: .78rem; color: var(--muted2); }

/* â•â•â•â•â•â•â• HERO DAILY CARD â•â•â•â•â•â•â• */
.daily-hero {
  background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
  border: 2px solid var(--accent); border-radius: 20px; padding: 1.5rem;
  margin-bottom: 1.5rem; position: relative; overflow: hidden;
}
.daily-hero::before { content:''; position:absolute; top:-30px; right:-30px; width:120px; height:120px;
  background: radial-gradient(circle, var(--accentT) 0%, transparent 70%); border-radius:50%; }
.daily-hero-label { font-size: .7rem; font-weight: 800; text-transform: uppercase; letter-spacing: .1em; color: var(--accent); margin-bottom: .4rem; }
.daily-hero-title { font-size: 1.3rem; font-weight: 900; margin-bottom: .3rem; }
.daily-hero-sub { font-size: .85rem; color: var(--muted2); margin-bottom: 1rem; }

/* â•â•â•â•â•â•â• QUESTION BLOCK â•â•â•â•â•â•â• */
.q-block {
  background: var(--surface); border: 2px solid var(--border); border-radius: 18px;
  padding: 1.3rem; margin-bottom: 1rem; transition: border-color .2s;
}
.q-num { font-family: var(--mono); font-size: .7rem; color: var(--accent); font-weight: 500; margin-bottom: .6rem; }
.q-text { font-size: 1rem; font-weight: 700; line-height: 1.6; margin-bottom: .9rem; }
.q-img { width: 100%; border-radius: 12px; margin-bottom: .9rem; border: 1px solid var(--border); display: block; }
.options-grid { display: grid; gap: .5rem; }
.option-btn {
  display: flex; align-items: center; gap: .8rem; padding: .85rem 1rem;
  background: var(--bg2); border: 2px solid var(--border); border-radius: 12px;
  cursor: pointer; transition: all .2s; text-align: left; width: 100%;
  font-family: var(--font); font-size: .95rem; color: var(--text);
}
.option-btn:hover { border-color: var(--accent); background: var(--accentT); }
.option-btn.selected { border-color: var(--accent); background: var(--accentT); }
.option-btn.correct { border-color: var(--green); background: rgba(34,211,160,.12); }
.option-btn.wrong { border-color: var(--red); background: rgba(248,113,113,.12); }
.option-letter {
  width: 30px; height: 30px; border-radius: 8px; background: var(--surface2);
  display: flex; align-items: center; justify-content: center; font-weight: 800;
  font-size: .8rem; flex-shrink: 0; transition: all .2s;
}
.option-btn.selected .option-letter { background: var(--accent); color: #000; }
.option-btn.correct .option-letter { background: var(--green); color: #000; }
.option-btn.wrong .option-letter { background: var(--red); color: #fff; }

/* â•â•â•â•â•â•â• BADGES â•â•â•â•â•â•â• */
.badge {
  display: inline-flex; align-items: center; gap: .3rem;
  padding: .2rem .65rem; border-radius: 99px; font-size: .72rem; font-weight: 800;
}
.badge-green { background: rgba(34,211,160,.15); color: var(--green); }
.badge-yellow { background: rgba(251,191,36,.15); color: var(--yellow); }
.badge-red { background: rgba(248,113,113,.15); color: var(--red); }
.badge-blue { background: var(--accentT); color: var(--accent); }

/* â•â•â•â•â•â•â• SCORE RESULT â•â•â•â•â•â•â• */
.result-screen { align-items: center; justify-content: center; padding: 1.5rem;
  background: radial-gradient(ellipse at 50% 0%, var(--surface) 0%, var(--bg) 70%); }
.result-box { max-width: 420px; width: 100%; }
.score-circle { position: relative; width: 150px; height: 150px; margin: 0 auto 1.5rem; }
.score-circle svg { transform: rotate(-90deg); width: 150px; height: 150px; }
.score-circle .score-text { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
.score-circle .score-pct { font-size: 2rem; font-weight: 900; display: block; }
.score-circle .score-lbl { font-size: .7rem; color: var(--muted2); font-weight: 700; }
.result-title { font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: .5rem; }
.result-sub { text-align: center; color: var(--muted2); margin-bottom: 1.5rem; }
.result-table { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 1.5rem; }
.rt-row { display: flex; justify-content: space-between; align-items: center; padding: .75rem 1rem; border-bottom: 1px solid var(--border); font-size: .9rem; }
.rt-row:last-child { border-bottom: none; }
.rt-row span:first-child { color: var(--muted2); }
.rt-row span:last-child { font-weight: 700; }

/* â•â•â•â•â•â•â• TEACHER PANEL â•â•â•â•â•â•â• */
.page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem; flex-wrap: wrap; gap: .5rem; }
.page-title { font-size: 1.3rem; font-weight: 900; }
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: .75rem; margin-bottom: 1.2rem; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; }
.stat-num { font-size: 2rem; font-weight: 900; color: var(--accent); line-height: 1; }
.stat-label { font-size: .75rem; color: var(--muted2); font-weight: 700; margin-top: .2rem; }

/* â•â•â•â•â•â•â• WIZARD STEPS â•â•â•â•â•â•â• */
.wizard { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; }
.wizard-header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 1rem 1.2rem; }
.wizard-title { font-size: 1rem; font-weight: 800; }
.wizard-sub { font-size: .8rem; color: var(--muted2); margin-top: .1rem; }
.wizard-body { padding: 1.2rem; }
.wizard-step { display: none; }
.wizard-step.active { display: block; }
.step-indicator { display: flex; gap: .4rem; margin-bottom: 1.2rem; }
.step-dot { height: 4px; flex: 1; border-radius: 99px; background: var(--border); transition: background .3s; }
.step-dot.done { background: var(--accent); }

/* â•â•â•â•â•â•â• OPTIONS EDITOR â•â•â•â•â•â•â• */
.option-edit-row {
  display: flex; align-items: center; gap: .5rem; margin-bottom: .5rem;
  background: var(--bg2); border: 2px solid var(--border); border-radius: 10px; padding: .5rem .6rem .5rem .8rem;
  cursor: pointer; transition: border-color .2s;
}
.option-edit-row.is-correct { border-color: var(--green); background: rgba(34,211,160,.07); }
.option-edit-input { flex: 1; background: transparent; border: none; color: var(--text); font-family: var(--font); font-size: .95rem; outline: none; }
.correct-toggle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid var(--border); background: transparent; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all .2s; font-size: .7rem; }
.correct-toggle.active { background: var(--green); border-color: var(--green); color: #000; }

/* â•â•â•â•â•â•â• DAILY BUILDER â•â•â•â•â•â•â• */
.q-picker { background: var(--bg2); border: 2px solid var(--border); border-radius: 12px; overflow: hidden; }
.q-picker-item { display: flex; align-items: center; gap: .75rem; padding: .85rem 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .15s; }
.q-picker-item:last-child { border-bottom: none; }
.q-picker-item:hover { background: var(--accentT); }
.q-picker-item.picked { background: var(--accentT); }
.q-picker-item .pick-check { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: .7rem; transition: all .2s; }
.q-picker-item.picked .pick-check { background: var(--accent); border-color: var(--accent); color: #000; }
.q-picker-text { font-size: .88rem; font-weight: 600; flex: 1; }
.q-picker-tag { font-size: .7rem; color: var(--muted2); }

/* â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â• */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 200; align-items: flex-end; justify-content: center; padding: 0; }
.overlay.open { display: flex; }
@media (min-width: 600px) { .overlay { align-items: center; padding: 1rem; } }
.modal { background: var(--surface); border-radius: 24px 24px 0 0; width: 100%; max-height: 92vh; overflow-y: auto; padding: 1.5rem; }
@media (min-width: 600px) { .modal { border-radius: 24px; max-width: 520px; max-height: 85vh; } }
.modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 99px; margin: 0 auto 1.2rem; }
@media (min-width: 600px) { .modal-handle { display: none; } }
.modal-title { font-size: 1.2rem; font-weight: 900; margin-bottom: 1.2rem; }

/* â•â•â•â•â•â•â• TIMER â•â•â•â•â•â•â• */
.timer-badge { background: var(--bg2); border: 2px solid var(--border); border-radius: 10px; padding: .3rem .75rem; font-family: var(--mono); font-size: .9rem; font-weight: 500; }
.timer-badge.warn { border-color: var(--yellow); color: var(--yellow); }
.timer-badge.danger { border-color: var(--red); color: var(--red); animation: pulse .6s infinite; }
@keyframes pulse { 50% { opacity: .6; } }

/* â•â•â•â•â•â•â• PROGRESS â•â•â•â•â•â•â• */
.progress-bar { background: var(--bg2); border-radius: 99px; height: 8px; overflow: hidden; margin: .75rem 0; }
.progress-fill { height: 100%; border-radius: 99px; background: var(--accent); transition: width .5s cubic-bezier(.34,1.56,.64,1); }

/* â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â• */
.toast { position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%) translateY(30px); 
  background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  padding: .75rem 1.2rem; border-radius: 12px; font-size: .9rem; font-weight: 700;
  z-index: 999; opacity: 0; transition: all .3s; white-space: nowrap; pointer-events: none;
  box-shadow: var(--shadow);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.ok { border-color: var(--green); }
.toast.err { border-color: var(--red); }

/* â•â•â•â•â•â•â• MISC â•â•â•â•â•â•â• */
.empty-state { text-align: center; padding: 3rem 1rem; }
.empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: .7; }
.empty-text { color: var(--muted2); font-weight: 700; }
.divider { border: none; border-top: 1px solid var(--border); margin: 1rem 0; }
.flex { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
.flex-1 { flex: 1; }
.text-accent { color: var(--accent); }
.text-muted { color: var(--muted2); }
.fw9 { font-weight: 900; }
.mt1 { margin-top: 1rem; }

/* â•â•â•â•â•â•â• CONFETTI CANVAS â•â•â•â•â•â•â• */
#confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 998; }

/* â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â• */
@media (min-width: 768px) {
  .stats-grid { grid-template-columns: repeat(4, 1fr); }
  .main { padding: 1.5rem; max-width: 800px; margin: 0 auto; }
}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active centered" id="screen-landing">
  <div class="landing-emoji">ğŸ“</div>
<h1 class="landing-title">Tashkent<span>Experiment</span></h1>
  <h1 class="landing-title">Math<span>Class</span></h1>
  <p class="landing-subtitle">O'quvchilar uchun interaktiv matematika platformasi</p>
  
  <div class="theme-row">
    <div class="theme-dot active" data-t="default" onclick="setTheme('default',this)" title="Ko'k"></div>
    <div class="theme-dot" data-t="ocean" onclick="setTheme('ocean',this)" title="Okean"></div>
    <div class="theme-dot" data-t="forest" onclick="setTheme('forest',this)" title="O'rmon"></div>
    <div class="theme-dot" data-t="sunset" onclick="setTheme('sunset',this)" title="Quyosh botishi"></div>
    <div class="theme-dot" data-t="lavender" onclick="setTheme('lavender',this)" title="Binafsha"></div>
    <div class="theme-dot" data-t="light" onclick="setTheme('light',this)" title="Yorug'lik"></div>
  </div>
  
  <div class="landing-btns">
    <button class="btn btn-primary btn-lg btn-full" onclick="goto('screen-student-login')">
      ğŸ“ O'quvchi sifatida kirish
    </button>
    <button class="btn btn-ghost btn-lg btn-full" onclick="goto('screen-teacher-login')">
      ğŸ“ O'qituvchi sifatida kirish
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDENT LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen form-wrap" id="screen-student-login">
  <div class="form-box">
    <div class="form-icon">ğŸ“</div>
    <div class="form-title">Xush kelibsiz!</div>
    <div class="form-sub">Ma'lumotlaringizni kiriting</div>
    <div class="field"><label>To'liq ismingiz</label>
      <input type="text" id="st-name" placeholder="Masalan: Ali Karimov" autocomplete="name">
    </div>
    <div class="field"><label>Sinfingiz</label>
      <input type="text" id="st-grade" placeholder="Masalan: 7A, 8B, 9D" autocomplete="off" style="text-transform:uppercase">
    </div>
    <div class="field"><label>Sinf kodi</label>
      <input type="text" id="st-code" placeholder="O'qituvchingizdan so'rang" autocomplete="off"
        onkeydown="if(event.key==='Enter')doStudentLogin()">
    </div>
    <button class="btn btn-primary btn-full btn-lg" onclick="doStudentLogin()">Kirish â†’</button>
    <div style="margin-top:.75rem">
      <button class="btn btn-ghost btn-full" onclick="goto('screen-landing')">â† Orqaga</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TEACHER LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen form-wrap" id="screen-teacher-login">
  <div class="form-box">
    <div class="form-icon">ğŸ“</div>
    <div class="form-title">O'qituvchi paneli</div>
    <div class="form-sub">Kirish uchun parolni kiriting</div>
    <div class="field"><label>Parol</label>
      <input type="password" id="t-pass" placeholder="Parolingiz"
        onkeydown="if(event.key==='Enter')doTeacherLogin()">
    </div>
    <button class="btn btn-primary btn-full btn-lg" onclick="doTeacherLogin()">Kirish â†’</button>
    <div style="margin-top:.75rem">
      <button class="btn btn-ghost btn-full" onclick="goto('screen-landing')">â† Orqaga</button>
    </div>
    <div class="divider"></div>
    <p style="font-size:.8rem;color:var(--muted2)">Boshlang'ich parol: <span style="font-family:var(--mono);color:var(--accent)">teacher123</span></p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDENT DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-student">
  <nav class="navbar">
    <div class="navbar-brand">ğŸ“ MathClass</div>
    <div class="navbar-user" id="st-navname"></div>
    <button class="btn btn-ghost btn-sm" onclick="goto('screen-landing')">Chiqish</button>
  </nav>
  <div class="main">
    <div class="section active" id="st-sec-daily"><div id="st-daily-area"></div></div>
    <div class="section" id="st-sec-tests"><div id="st-tests-area"></div></div>
    <div class="section" id="st-sec-history"><div id="st-history-area"></div></div>
  </div>
  <nav class="bottom-nav">
    <div class="bnav-item active" onclick="stTab('daily',this)">
      <div class="bnav-icon">ğŸ“…</div><div>Kunlik</div>
    </div>
    <div class="bnav-item" onclick="stTab('tests',this)">
      <div class="bnav-icon">ğŸ“‹</div><div>Testlar</div>
    </div>
    <div class="bnav-item" onclick="stTab('history',this)">
      <div class="bnav-icon">ğŸ“Š</div><div>Natijalar</div>
    </div>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TEST TAKING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-test">
  <nav class="navbar">
    <div class="navbar-brand flex-1" id="test-nav-title">Test</div>
    <div class="timer-badge" id="test-timer" style="display:none">00:00</div>
    <button class="btn btn-primary btn-sm" onclick="submitTest()">Yuborish â†’</button>
  </nav>
  <div class="main" id="test-body">
    <div id="test-progress-wrap">
      <div class="flex" style="justify-content:space-between;font-size:.8rem;color:var(--muted2);font-weight:700">
        <span id="test-prog-label">Savol 0 / 0</span>
        <span id="test-prog-pct">0%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="test-progress" style="width:0%"></div></div>
    </div>
    <div id="test-questions"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen result-screen centered" id="screen-result">
  <div class="result-box">
    <div class="score-circle">
      <svg viewBox="0 0 150 150">
        <circle cx="75" cy="75" r="65" fill="none" stroke="var(--bg2)" stroke-width="14"/>
        <circle cx="75" cy="75" r="65" fill="none" stroke="var(--accent)" stroke-width="14"
          stroke-linecap="round" stroke-dasharray="408" stroke-dashoffset="408"
          id="score-arc" style="transition:stroke-dashoffset 1.5s cubic-bezier(.34,1.56,.64,1)"/>
      </svg>
      <div class="score-text">
        <span class="score-pct" id="res-pct">0%</span>
        <span class="score-lbl">BALL</span>
      </div>
    </div>
    <div class="result-title" id="res-title">Ajoyib!</div>
    <div class="result-sub" id="res-sub"></div>
    <div class="result-table" id="res-table"></div>
    <button class="btn btn-ghost btn-full btn-lg" onclick="goHome()">â† Bosh sahifaga</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TEACHER PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-teacher">
  <nav class="navbar">
    <div class="navbar-brand">ğŸ“ O'qituvchi</div>
    <button class="btn btn-ghost btn-sm" onclick="goto('screen-landing')">Chiqish</button>
  </nav>
  <div class="main">
    <div class="section active" id="t-sec-overview"><div id="t-overview"></div></div>
    <div class="section" id="t-sec-questions"><div id="t-questions"></div></div>
    <div class="section" id="t-sec-tests"><div id="t-tests"></div></div>
    <div class="section" id="t-sec-daily"><div id="t-daily"></div></div>
    <div class="section" id="t-sec-results"><div id="t-results"></div></div>
    <div class="section" id="t-sec-settings"><div id="t-settings"></div></div>
  </div>
  <nav class="bottom-nav">
    <div class="bnav-item active" onclick="tTab('overview',this)"><div class="bnav-icon">ğŸ“Š</div><div>Asosiy</div></div>
    <div class="bnav-item" onclick="tTab('questions',this)"><div class="bnav-icon">â“</div><div>Savollar</div></div>
    <div class="bnav-item" onclick="tTab('tests',this)"><div class="bnav-icon">ğŸ“‹</div><div>Testlar</div></div>
    <div class="bnav-item" onclick="tTab('daily',this)"><div class="bnav-icon">ğŸ“…</div><div>Kunlik</div></div>
    <div class="bnav-item" onclick="tTab('results',this)"><div class="bnav-icon">ğŸ“¨</div><div>Natija</div></div>
    <div class="bnav-item" onclick="tTab('settings',this)"><div class="bnav-icon">âš™ï¸</div><div>Sozlama</div></div>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL: ADD/EDIT QUESTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="ov-question">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="mq-title-label">Yangi savol qo'shish</div>

    <!-- Step indicator -->
    <div class="step-indicator">
      <div class="step-dot done" id="qstep-1"></div>
      <div class="step-dot" id="qstep-2"></div>
      <div class="step-dot" id="qstep-3"></div>
    </div>

    <!-- Step 1: Question text & image -->
    <div class="wizard-step active" id="qwiz-1">
      <div style="font-size:.9rem;font-weight:800;color:var(--muted2);margin-bottom:.75rem">1-qadam: Savol matnini kiriting</div>
      <div class="field">
        <label>Savol matni</label>
        <textarea id="mq-text" rows="4" placeholder="Masalan: 7 Ã— 8 nechiga teng?"></textarea>
      </div>
      <div class="field">
        <label>Rasm (ixtiyoriy)</label>
        <input type="file" id="mq-img-file" accept="image/*" style="padding:.5rem;color:var(--muted2)">
        <img id="mq-img-preview" style="display:none;max-width:100%;border-radius:10px;margin-top:.5rem">
      </div>
      <div class="field">
        <label>Mavzu / Teg (ixtiyoriy)</label>
        <input type="text" id="mq-tag" placeholder="Masalan: Algebra, Geometriya">
      </div>
      <div class="flex" style="justify-content:flex-end;margin-top:1rem">
        <button class="btn btn-ghost" onclick="closeOv('ov-question')">Bekor</button>
        <button class="btn btn-primary" onclick="qwizNext(2)">Keyingi â†’</button>
      </div>
    </div>

    <!-- Step 2: Options -->
    <div class="wizard-step" id="qwiz-2">
      <div style="font-size:.9rem;font-weight:800;color:var(--muted2);margin-bottom:.75rem">2-qadam: Javob variantlarini kiriting</div>
      <p style="font-size:.82rem;color:var(--muted2);margin-bottom:.75rem">âœ… belgisini bosib to'g'ri javobni belgilang</p>
      <div id="mq-opts"></div>
      <button class="btn btn-ghost btn-sm" onclick="addOptRow()" style="margin-top:.4rem">+ Variant qo'shish</button>
      <div class="flex" style="justify-content:space-between;margin-top:1rem">
        <button class="btn btn-ghost" onclick="qwizNext(1)">â† Orqaga</button>
        <button class="btn btn-primary" onclick="qwizNext(3)">Keyingi â†’</button>
      </div>
    </div>

    <!-- Step 3: Preview & save -->
    <div class="wizard-step" id="qwiz-3">
      <div style="font-size:.9rem;font-weight:800;color:var(--muted2);margin-bottom:.75rem">3-qadam: Tekshirib saqlang</div>
      <div id="mq-preview" style="background:var(--bg2);border-radius:12px;padding:1rem;margin-bottom:1rem"></div>
      <div class="flex" style="justify-content:space-between">
        <button class="btn btn-ghost" onclick="qwizNext(2)">â† Orqaga</button>
        <button class="btn btn-primary" onclick="saveQuestion()">âœ“ Saqlash</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL: CREATE TEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="ov-test">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Yangi test yaratish</div>
    <div class="field">
      <label>Test nomi</label>
      <input type="text" id="mt-name" placeholder="Masalan: 3-bob tekshiruvi">
    </div>
    <div class="field">
      <label>Vaqt chegarasi (daqiqa, 0 = chegarasiz)</label>
      <input type="number" id="mt-time" value="0" min="0" placeholder="0">
    </div>
    <div class="field">
      <label>Savollarni tanlang (âœ“ belgisi bilan belgilang)</label>
      <div id="mt-qpicker" class="q-picker" style="max-height:280px;overflow-y:auto"></div>
    </div>
    <div class="flex" style="justify-content:space-between;margin-top:1rem">
      <button class="btn btn-ghost" onclick="closeOv('ov-test')">Bekor</button>
      <button class="btn btn-primary" onclick="saveTest()">âœ“ Test yaratish</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DBKEY = 'mc_v3';
let DB = {
  questions: [], tests: [], dailyTask: null, results: [],
  settings: { token: '', chatId: '', classCode: 'sinf2024', pass: 'teacher123', theme: 'default' }
};
function dbLoad() {
  try { const r = localStorage.getItem(DBKEY); if (r) DB = JSON.parse(r); } catch(e) {}
}
function dbSave() { localStorage.setItem(DBKEY, JSON.stringify(DB)); }
dbLoad();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTheme(t, el) {
  document.documentElement.setAttribute('data-theme', t === 'default' ? '' : t);
  document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
  if (el) el.classList.add('active');
  DB.settings.theme = t; dbSave();
}
// apply saved theme
(function() {
  const t = DB.settings.theme || 'default';
  if (t !== 'default') document.documentElement.setAttribute('data-theme', t);
  const dot = document.querySelector(`.theme-dot[data-t="${t}"]`);
  if (dot) { document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active')); dot.classList.add('active'); }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goto(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}
function stTab(name, el) {
  document.querySelectorAll('#screen-student .section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('#screen-student .bnav-item').forEach(b => b.classList.remove('active'));
  document.getElementById('st-sec-'+name).classList.add('active');
  el.classList.add('active');
  renderStudent(name);
}
function tTab(name, el) {
  document.querySelectorAll('#screen-teacher .section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('#screen-teacher .bnav-item').forEach(b => b.classList.remove('active'));
  document.getElementById('t-sec-'+name).classList.add('active');
  el.classList.add('active');
  renderTeacher(name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ME = null;
function doStudentLogin() {
  const name = document.getElementById('st-name').value.trim();
  const grade = document.getElementById('st-grade').value.trim().toUpperCase();
  const code = document.getElementById('st-code').value.trim();
  if (!name) { toast('Ismingizni kiriting', 'err'); return; }
  if (!grade) { toast('Sinfingizni tanlang', 'err'); return; }
  if (code !== DB.settings.classCode) { toast("Noto'g'ri sinf kodi!", 'err'); return; }
  ME = { name, grade };
  document.getElementById('st-navname').textContent = 'ğŸ‘¤ ' + name + ' Â· ' + grade;
  goto('screen-student');
  renderStudent('daily');
}
function doTeacherLogin() {
  const pass = document.getElementById('t-pass').value;
  if (pass !== DB.settings.pass) { toast("Noto'g'ri parol", 'err'); return; }
  goto('screen-teacher');
  renderTeacher('overview');
}
function goHome() {
  goto('screen-student');
  stTab('daily', document.querySelector('#screen-student .bnav-item'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDENT RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStudent(sec) {
  if (sec === 'daily') renderStDaily();
  if (sec === 'tests') renderStTests();
  if (sec === 'history') renderStHistory();
}

function renderStDaily() {
  const area = document.getElementById('st-daily-area');
  const dt = DB.dailyTask;
  if (!dt || !dt.qids || !dt.qids.length) {
    area.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-text">Bugun kunlik topshiriq yo'q.<br>Ertaga qaytib keling!</div></div>`;
    return;
  }
  const today = new Date().toDateString();
  const done = DB.results.find(r => r.uid === ME.name + '_daily_' + today);
  if (done) {
    area.innerHTML = `
      <div class="daily-hero">
        <div class="daily-hero-label">âœ… Bugungi topshiriq bajarildi!</div>
        <div class="daily-hero-title">${dt.title || 'Kunlik mashq'}</div>
        <div class="daily-hero-sub">Siz ${done.score}/${done.total} ball to'pladingiz. Ajoyib!</div>
      </div>
      <div class="card"><p class="text-muted">Ertaga yangi topshiriq bo'ladi. ğŸŒŸ</p></div>`;
    return;
  }
  const qs = dt.qids.map(id => DB.questions.find(q => q.id === id)).filter(Boolean);
  area.innerHTML = `
    <div class="daily-hero">
      <div class="daily-hero-label">ğŸ“… Kunlik topshiriq</div>
      <div class="daily-hero-title">${dt.title || 'Kunlik mashq'}</div>
      <div class="daily-hero-sub">${qs.length} ta savol</div>
    </div>
    <div id="daily-qs"></div>
    <button class="btn btn-primary btn-full btn-lg" style="margin-top:1rem" onclick="submitActivity('daily')">âœ“ Topshiriq yakunlash</button>`;
  renderQs('daily-qs', dt.qids, 'daily');
}

function renderStTests() {
  const area = document.getElementById('st-tests-area');
  if (!DB.tests.length) {
    area.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Hozircha test yo'q.</div></div>`;
    return;
  }
  area.innerHTML = '<div class="page-header"><div class="page-title">Testlar</div></div>' +
    DB.tests.map(t => {
      const done = DB.results.find(r => r.uid === ME.name + '_test_' + t.id);
      return `<div class="card">
        <div class="flex">
          <div class="flex-1">
            <div class="card-title">${t.title}</div>
            <div class="card-meta">${t.qids.length} ta savol${t.time ? ' Â· â± ' + t.time + ' daqiqa' : ''}</div>
          </div>
          ${done
            ? `<span class="badge ${gradeBadge(done.score,done.total)}">âœ“ ${done.score}/${done.total}</span>`
            : `<button class="btn btn-primary btn-sm" onclick="startTest('${t.id}')">Boshlash â†’</button>`}
        </div>
      </div>`;
    }).join('');
}

function renderStHistory() {
  const area = document.getElementById('st-history-area');
  const mine = DB.results.filter(r => r.student === ME.name).reverse();
  if (!mine.length) {
    area.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Hozircha natijalari yo'q.</div></div>`;
    return;
  }
  area.innerHTML = '<div class="page-header"><div class="page-title">Mening natijalarim</div></div>' +
    mine.map(r => {
      const pct = Math.round(r.score/r.total*100);
      return `<div class="card"><div class="flex">
        <div class="flex-1">
          <div class="card-title">${r.title}</div>
          <div class="card-meta">${r.date}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:900;font-size:1.2rem">${r.score}/${r.total}</div>
          <span class="badge ${gradeBadge(r.score,r.total)}">${pct}%</span>
        </div>
      </div></div>`;
    }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTION RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let answers = {};
function renderQs(containerId, qids, mode) {
  answers = {};
  const qs = qids.map(id => DB.questions.find(q => q.id === id)).filter(Boolean);
  const c = document.getElementById(containerId);
  if (!c) return;
  c.innerHTML = qs.map((q, i) => `
    <div class="q-block">
      <div class="q-num">SAVOL ${i+1}${q.tag ? ' Â· ' + q.tag : ''}</div>
      <div class="q-text">${q.text}</div>
      ${q.img ? `<img class="q-img" src="${q.img}">` : ''}
      <div class="options-grid">
        ${q.opts.map((o, j) => `
          <button class="option-btn" id="opt_${mode}_${q.id}_${j}" onclick="pickOpt('${mode}','${q.id}',${j},${q.opts.length})">
            <span class="option-letter">${'ABCD'[j]}</span>
            <span>${o}</span>
          </button>`).join('')}
      </div>
    </div>`).join('');
  updateTestProgress(qids);
}

function pickOpt(mode, qid, idx, count) {
  for(let j=0;j<count;j++) {
    const el = document.getElementById(`opt_${mode}_${qid}_${j}`);
    if(el) el.classList.remove('selected');
  }
  const sel = document.getElementById(`opt_${mode}_${qid}_${idx}`);
  if(sel) sel.classList.add('selected');
  answers[qid] = idx;
  updateTestProgress(activeTestQids);
}

let activeTestQids = [];
function updateTestProgress(qids) {
  if (!qids || !qids.length) return;
  const answered = qids.filter(id => answers[id] !== undefined).length;
  const pct = Math.round(answered / qids.length * 100);
  const pb = document.getElementById('test-progress');
  const pl = document.getElementById('test-prog-label');
  const pp = document.getElementById('test-prog-pct');
  if (pb) pb.style.width = pct + '%';
  if (pl) pl.textContent = `Savol ${answered} / ${qids.length}`;
  if (pp) pp.textContent = pct + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAKE TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeTest = null;
let timerInt = null;
let timerSec = 0;

function startTest(tid) {
  const t = DB.tests.find(x => x.id === tid);
  if (!t) return;
  activeTest = t;
  activeTestQids = t.qids;
  answers = {};
  document.getElementById('test-nav-title').textContent = t.title;
  document.getElementById('test-progress-wrap').style.display = 'block';
  
  const tbody = document.getElementById('test-questions');
  const qs = t.qids.map(id => DB.questions.find(q => q.id === id)).filter(Boolean);
  tbody.innerHTML = qs.map((q,i) => `
    <div class="q-block">
      <div class="q-num">SAVOL ${i+1}${q.tag?' Â· '+q.tag:''}</div>
      <div class="q-text">${q.text}</div>
      ${q.img?`<img class="q-img" src="${q.img}">`:''}
      <div class="options-grid">
        ${q.opts.map((o,j)=>`
          <button class="option-btn" id="opt_test_${q.id}_${j}" onclick="pickOpt('test','${q.id}',${j},${q.opts.length})">
            <span class="option-letter">${'ABCD'[j]}</span><span>${o}</span>
          </button>`).join('')}
      </div>
    </div>`).join('') + '<div style="height:1rem"></div>';
  
  updateTestProgress(t.qids);
  
  clearInterval(timerInt);
  if (t.time > 0) {
    timerSec = t.time * 60;
    document.getElementById('test-timer').style.display = 'block';
    updateTimerUI();
    timerInt = setInterval(() => {
      timerSec--;
      updateTimerUI();
      if (timerSec <= 0) { clearInterval(timerInt); submitTest(); }
    }, 1000);
  } else {
    document.getElementById('test-timer').style.display = 'none';
  }
  goto('screen-test');
}

function updateTimerUI() {
  const m = String(Math.floor(timerSec/60)).padStart(2,'0');
  const s = String(timerSec%60).padStart(2,'0');
  const el = document.getElementById('test-timer');
  el.textContent = `${m}:${s}`;
  el.className = 'timer-badge' + (timerSec<30?' danger':timerSec<60?' warn':'');
}

function submitTest() {
  clearInterval(timerInt);
  const t = activeTest;
  if (!t) return;
  const qs = t.qids.map(id => DB.questions.find(q => q.id === id)).filter(Boolean);
  let score = 0;
  qs.forEach(q => { if (answers[q.id] !== undefined && answers[q.id] === q.correct) score++; });
  const res = {
    uid: ME.name + '_test_' + t.id,
    id: Date.now()+"", student: ME.name, grade: ME.grade,
    title: t.title, type: 'test', testId: t.id,
    score, total: qs.length,
    date: new Date().toLocaleString('uz-UZ'),
    timestamp: new Date().toISOString()
  };
  DB.results.push(res); dbSave();
  sendTG(res);
  showResult(res);
}

function submitActivity(type) {
  const dt = DB.dailyTask;
  const qs = dt.qids.map(id => DB.questions.find(q => q.id === id)).filter(Boolean);
  let score = 0;
  qs.forEach(q => { if (answers[q.id] !== undefined && answers[q.id] === q.correct) score++; });
  const today = new Date().toDateString();
  const res = {
    uid: ME.name + '_daily_' + today,
    id: Date.now()+"", student: ME.name, grade: ME.grade,
    title: dt.title || 'Kunlik mashq', type: 'daily',
    score, total: qs.length,
    date: new Date().toLocaleString('uz-UZ'),
    timestamp: new Date().toISOString()
  };
  DB.results.push(res); dbSave();
  sendTG(res);
  showResult(res);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResult(res) {
  const pct = Math.round(res.score / res.total * 100);
  const arc = document.getElementById('score-arc');
  const circumference = 408;
  arc.style.stroke = pct>=80 ? 'var(--green)' : pct>=50 ? 'var(--yellow)' : 'var(--red)';
  setTimeout(() => {
    arc.style.strokeDashoffset = circumference - (circumference * pct / 100);
  }, 100);
  document.getElementById('res-pct').textContent = pct + '%';
  
  const msgs = [
    [90, 'ğŸ† Zo\'r! A\'lo natija!'],
    [70, 'â­ Yaxshi natija!'],
    [50, 'ğŸ‘ Davom eting!'],
    [0,  'ğŸ’ª Harakat qiling!']
  ];
  document.getElementById('res-title').textContent = msgs.find(m => pct >= m[0])[1];
  document.getElementById('res-sub').textContent = `${res.total} savoldan ${res.score} tasiga to'g'ri javob berdingiz`;
  document.getElementById('res-table').innerHTML = `
    <div class="rt-row"><span>Topshiriq</span><span>${res.title}</span></div>
    <div class="rt-row"><span>Ball</span><span>${res.score} / ${res.total}</span></div>
    <div class="rt-row"><span>Foiz</span><span>${pct}%</span></div>
    <div class="rt-row"><span>Sana</span><span>${res.date}</span></div>
    <div class="rt-row"><span>Holat</span><span><span class="badge ${gradeBadge(res.score,res.total)}">${pct>=60?'O\'tdi':'Qoldi'}</span></span></div>`;
  goto('screen-result');
  if (pct >= 70) launchConfetti();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEACHER RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTeacher(sec) {
  if (sec === 'overview') renderTOverview();
  if (sec === 'questions') renderTQuestions();
  if (sec === 'tests') renderTTests();
  if (sec === 'daily') renderTDaily();
  if (sec === 'results') renderTResults();
  if (sec === 'settings') renderTSettings();
}

function renderTOverview() {
  const students = [...new Set(DB.results.map(r => r.student))].length;
  const avgScore = DB.results.length
    ? Math.round(DB.results.reduce((a,r) => a + r.score/r.total*100, 0) / DB.results.length)
    : 0;
  document.getElementById('t-overview').innerHTML = `
    <div class="page-title" style="margin-bottom:1rem">Umumiy ko'rinish</div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num">${DB.questions.length}</div><div class="stat-label">Savollar</div></div>
      <div class="stat-card"><div class="stat-num">${DB.tests.length}</div><div class="stat-label">Testlar</div></div>
      <div class="stat-card"><div class="stat-num">${DB.results.length}</div><div class="stat-label">Topshirishlar</div></div>
      <div class="stat-card"><div class="stat-num">${students}</div><div class="stat-label">O'quvchilar</div></div>
    </div>
    ${DB.results.length ? `<div class="card"><div class="card-title">O'rtacha ball</div><div class="progress-bar"><div class="progress-fill" style="width:${avgScore}%"></div></div><div style="font-size:1.2rem;font-weight:900;color:var(--accent)">${avgScore}%</div></div>` : ''}
    <div class="page-title" style="margin:1rem 0 .75rem">So'nggi natijalar</div>
    ${DB.results.length === 0 ? `<div class="empty-state"><div class="empty-icon">ğŸ“¨</div><div class="empty-text">Hozircha natija yo'q</div></div>` :
    [...DB.results].reverse().slice(0,8).map(r => `
      <div class="card"><div class="flex">
        <div class="flex-1"><div class="card-title">${r.student}${r.grade ? ` <span class="badge badge-blue">${r.grade}</span>` : ''}</div><div class="card-meta">${r.title} Â· ${r.date}</div></div>
        <span class="badge ${gradeBadge(r.score,r.total)}">${r.score}/${r.total}</span>
      </div></div>`).join('')}`;
}

function renderTQuestions() {
  document.getElementById('t-questions').innerHTML = `
    <div class="page-header">
      <div class="page-title">Savol banki</div>
      <button class="btn btn-primary btn-sm" onclick="openAddQ()">+ Savol qo'shish</button>
    </div>
    ${DB.questions.length === 0 ? `<div class="empty-state"><div class="empty-icon">â“</div><div class="empty-text">Hozircha savol yo'q.<br>"Savol qo'shish" tugmasini bosing!</div></div>` :
    DB.questions.map((q,i) => `
      <div class="card">
        <div class="flex">
          <div class="flex-1">
            <div class="q-num">#${i+1}${q.tag?' Â· '+q.tag:''}</div>
            <div class="card-title">${q.text.substring(0,80)}${q.text.length>80?'...':''}</div>
            <div class="card-meta">${q.opts.length} variant Â· To'g'ri: <b>${'ABCD'[q.correct]}</b>${q.img?' Â· ğŸ–¼':''}</div>
          </div>
          <div class="flex" style="flex-shrink:0">
            <button class="btn btn-ghost btn-sm" onclick="openEditQ('${q.id}')">âœï¸</button>
            <button class="btn btn-danger btn-sm" onclick="deleteQ('${q.id}')">ğŸ—‘</button>
          </div>
        </div>
      </div>`).join('')}`;
}

function renderTTests() {
  document.getElementById('t-tests').innerHTML = `
    <div class="page-header">
      <div class="page-title">Testlar</div>
      <button class="btn btn-primary btn-sm" onclick="openCreateTest()">+ Test yaratish</button>
    </div>
    ${DB.tests.length === 0 ? `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Hozircha test yo'q</div></div>` :
    DB.tests.map(t => {
      const attempts = DB.results.filter(r => r.testId === t.id).length;
      return `<div class="card">
        <div class="flex">
          <div class="flex-1">
            <div class="card-title">${t.title}</div>
            <div class="card-meta">${t.qids.length} savol${t.time?' Â· â± '+t.time+' daqiqa':''} Â· ${attempts} ta urinish</div>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteTest('${t.id}')">ğŸ—‘</button>
        </div>
      </div>`;}).join('')}`;
}

function renderTDaily() {
  const dt = DB.dailyTask;
  document.getElementById('t-daily').innerHTML = `
    <div class="page-title" style="margin-bottom:1rem">Kunlik topshiriq</div>
    
    <div class="card">
      <div class="card-title" style="margin-bottom:.75rem">ğŸ“Œ Hozirgi kunlik topshiriq</div>
      ${dt && dt.qids && dt.qids.length
        ? `<div style="font-weight:800">${dt.title||'Kunlik mashq'}</div>
           <div class="card-meta">${dt.qids.length} ta savol</div>`
        : `<div class="text-muted">Hozircha kunlik topshiriq belgilanmagan</div>`}
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:1rem">âœï¸ Yangi kunlik topshiriq belgilash</div>
      <div class="field">
        <label>Topshiriq nomi</label>
        <input type="text" id="dt-title" value="${dt ? (dt.title||'') : ''}" placeholder="Masalan: Bugungi arifmetika">
      </div>
      <div class="field">
        <label>Savollarni tanlang</label>
        ${DB.questions.length === 0
          ? `<p class="text-muted" style="font-size:.85rem">Avval savol baniga savol qo'shing!</p>`
          : `<div class="q-picker" id="dt-picker">${DB.questions.map(q=>`
              <div class="q-picker-item ${dt&&dt.qids&&dt.qids.includes(q.id)?'picked':''}" id="dtp_${q.id}" onclick="toggleDTPick('${q.id}')">
                <div class="pick-check">${dt&&dt.qids&&dt.qids.includes(q.id)?'âœ“':''}</div>
                <div><div class="q-picker-text">${q.text.substring(0,70)}</div><div class="q-picker-tag">${q.tag||'Umumiy'}</div></div>
              </div>`).join('')}</div>`}
      </div>
      <button class="btn btn-primary" onclick="saveDailyTask()">âœ“ Kunlik topshiriqni saqlash</button>
    </div>`;
}

function toggleDTPick(id) {
  const el = document.getElementById('dtp_' + id);
  const isPicked = el.classList.toggle('picked');
  el.querySelector('.pick-check').textContent = isPicked ? 'âœ“' : '';
}

function saveDailyTask() {
  const title = document.getElementById('dt-title').value.trim() || 'Kunlik mashq';
  const picked = [...document.querySelectorAll('#dt-picker .q-picker-item.picked')].map(el => el.id.replace('dtp_',''));
  if (!picked.length) { toast("Kamida 1 ta savol tanlang", 'err'); return; }
  DB.dailyTask = { title, qids: picked };
  dbSave();
  toast("Kunlik topshiriq saqlandi! âœ“", 'ok');
  renderTDaily();
}

function renderTResults() {
  document.getElementById('t-results').innerHTML = `
    <div class="page-header">
      <div class="page-title">Natijalar</div>
      <div class="flex">
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â¬‡ CSV</button>
        <button class="btn btn-danger btn-sm" onclick="if(confirm("Barcha natijalar o'chirilsinmi?")){DB.results=[];dbSave();renderTResults();}">ğŸ—‘ Tozalash</button>
      </div>
    </div>
    ${DB.results.length === 0 ? `<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Hozircha natija yo'q</div></div>` :
    [...DB.results].reverse().map(r => {
      const pct = Math.round(r.score/r.total*100);
      return `<div class="card"><div class="flex">
        <div class="flex-1">
          <div class="card-title">${r.student}${r.grade ? ` <span class="badge badge-blue">${r.grade}</span>` : ''}</div>
          <div class="card-meta">${r.title} Â· ${r.date} Â· <span class="badge badge-blue">${r.type==='daily'?'Kunlik':'Test'}</span></div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-weight:900">${r.score}/${r.total}</div>
          <span class="badge ${gradeBadge(r.score,r.total)}">${pct}%</span>
        </div>
      </div></div>`;}).join('')}`;
}

function renderTSettings() {
  document.getElementById('t-settings').innerHTML = `
    <div class="page-title" style="margin-bottom:1rem">Sozlamalar</div>
    
    <div class="card" style="border-color:var(--green);background:rgba(34,211,160,.05);margin-bottom:1rem">
      <div class="card-title" style="color:var(--green);margin-bottom:.5rem">ğŸ¤– Telegram orqali natijalar olish</div>
      <p style="font-size:.82rem;color:var(--muted2);line-height:1.7">
        1. Telegramda <b>@BotFather</b> ni oching â†’ <b>/newbot</b> yuboring â†’ <b>Token</b> oling<br>
        2. Botingizga xabar yuboring, so'ng:<br>
        <span style="font-family:var(--mono);font-size:.75rem;color:var(--accent)">https://api.telegram.org/bot&lt;TOKEN&gt;/getUpdates</span><br>
        manzilidan <b>Chat ID</b> ni toping<br>
        3. Quyida ikkalasini kiriting va saqlang
      </p>
    </div>

    <div class="card">
      <div class="field"><label>Telegram Bot Token</label><input type="text" id="set-token" value="${DB.settings.token||''}" placeholder="123456789:ABCdef..."></div>
      <div class="field"><label>Telegram Chat ID</label><input type="text" id="set-chatid" value="${DB.settings.chatId||''}" placeholder="123456789"></div>
      <div class="field"><label>Sinf kodi (o'quvchilar uchun)</label><input type="text" id="set-code" value="${DB.settings.classCode||'sinf2024'}"></div>
      <div class="field"><label>Yangi parol (bo'sh qoldirsangiz o'zgarmaydi)</label><input type="password" id="set-pass" placeholder="Yangi parol"></div>
      <div class="flex" style="gap:.75rem;margin-top:.5rem">
        <button class="btn btn-primary" onclick="saveSettings()">âœ“ Saqlash</button>
        <button class="btn btn-ghost" onclick="testTG()">ğŸ“¬ Sinab ko'rish</button>
      </div>
    </div>

    <div class="card" style="margin-top:.5rem">
      <div class="card-title" style="margin-bottom:.75rem">ğŸ¨ Mavzu tanlash</div>
      <div class="theme-row" style="justify-content:flex-start">
        <div class="theme-dot" data-t="default" onclick="setTheme('default',this)" title="Ko'k"></div>
        <div class="theme-dot" data-t="ocean" onclick="setTheme('ocean',this)" title="Okean"></div>
        <div class="theme-dot" data-t="forest" onclick="setTheme('forest',this)" title="O'rmon"></div>
        <div class="theme-dot" data-t="sunset" onclick="setTheme('sunset',this)" title="Quyosh botishi"></div>
        <div class="theme-dot" data-t="lavender" onclick="setTheme('lavender',this)" title="Binafsha"></div>
        <div class="theme-dot" data-t="light" onclick="setTheme('light',this)" title="Yorug'lik"></div>
      </div>
    </div>`;
  
  // Reapply current theme dot active state
  const t = DB.settings.theme || 'default';
  document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
  document.querySelectorAll(`.theme-dot[data-t="${t}"]`).forEach(d => d.classList.add('active'));
}

function saveSettings() {
  DB.settings.token = document.getElementById('set-token').value.trim();
  DB.settings.chatId = document.getElementById('set-chatid').value.trim();
  DB.settings.classCode = document.getElementById('set-code').value.trim() || 'sinf2024';
  const np = document.getElementById('set-pass').value;
  if (np) DB.settings.pass = np;
  dbSave();
  toast("Sozlamalar saqlandi âœ“", 'ok');
}

async function testTG() {
  const ok = await sendTGMsg("âœ… MathClass boti ulandi! O'quvchilar natijalari shu yerga keladi.");
  toast(ok ? "Telegram xabar yuborildi! âœ“" : "Telegram xatolik. Token va Chat ID ni tekshiring.", ok?'ok':'err');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTION WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingQId = null;
let imgData = null;
let qwizStep = 1;

function openAddQ() {
  editingQId = null; imgData = null;
  document.getElementById('mq-text').value = '';
  document.getElementById('mq-tag').value = '';
  document.getElementById('mq-img-file').value = '';
  document.getElementById('mq-img-preview').style.display = 'none';
  document.getElementById('mq-title-label').textContent = 'Yangi savol qo\'shish';
  buildOptRows([{t:'',c:false},{t:'',c:false},{t:'',c:false},{t:'',c:false}]);
  qwizGo(1);
  openOv('ov-question');
}

function openEditQ(id) {
  const q = DB.questions.find(x => x.id === id);
  if (!q) return;
  editingQId = id; imgData = q.img || null;
  document.getElementById('mq-text').value = q.text;
  document.getElementById('mq-tag').value = q.tag || '';
  document.getElementById('mq-title-label').textContent = 'Savol tahrirlash';
  if (q.img) { const p = document.getElementById('mq-img-preview'); p.src = q.img; p.style.display='block'; }
  else document.getElementById('mq-img-preview').style.display = 'none';
  buildOptRows(q.opts.map((t,i) => ({t, c: i===q.correct})));
  qwizGo(1);
  openOv('ov-question');
}

function buildOptRows(opts) {
  const c = document.getElementById('mq-opts');
  c.innerHTML = '';
  opts.forEach((o,i) => addOptRowWith(o.t, o.c));
}

function addOptRow() {
  addOptRowWith('', false);
}

function addOptRowWith(val, isCorrect) {
  const c = document.getElementById('mq-opts');
  const idx = c.children.length;
  const div = document.createElement('div');
  div.className = 'option-edit-row' + (isCorrect ? ' is-correct' : '');
  div.innerHTML = `
    <span style="font-family:var(--mono);font-size:.8rem;color:var(--muted2);min-width:1.2rem">${'ABCD'[idx]||idx}</span>
    <input class="option-edit-input" placeholder="Variant ${idx+1}" value="${val.replace(/"/g,'&quot;')}">
    <button type="button" class="correct-toggle${isCorrect?' active':''}" onclick="markCorrect(this)" title="To'g'ri javob">âœ“</button>
    <button type="button" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;padding:.2rem" onclick="this.parentElement.remove()">âœ•</button>`;
  c.appendChild(div);
}

function markCorrect(btn) {
  document.querySelectorAll('#mq-opts .correct-toggle').forEach(b => { b.classList.remove('active'); b.closest('.option-edit-row').classList.remove('is-correct'); });
  btn.classList.add('active');
  btn.closest('.option-edit-row').classList.add('is-correct');
}

function qwizNext(step) { qwizGo(step); }

function qwizGo(step) {
  qwizStep = step;
  document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
  document.getElementById('qwiz-'+step).classList.add('active');
  for(let i=1;i<=3;i++) {
    const dot = document.getElementById('qstep-'+i);
    dot.classList.toggle('done', i <= step);
  }
  if (step === 3) buildQPreview();
}

function buildQPreview() {
  const text = document.getElementById('mq-text').value.trim() || '(Matn kiritilmagan)';
  const rows = [...document.querySelectorAll('#mq-opts .option-edit-row')];
  const opts = rows.map(r => r.querySelector('.option-edit-input').value.trim());
  const correctIdx = rows.findIndex(r => r.querySelector('.correct-toggle').classList.contains('active'));
  
  document.getElementById('mq-preview').innerHTML = `
    <div class="q-text" style="margin-bottom:.75rem">${text}</div>
    ${imgData ? `<img src="${imgData}" style="max-width:100%;border-radius:8px;margin-bottom:.75rem">` : ''}
    <div class="options-grid">
      ${opts.map((o,i) => `<div style="display:flex;gap:.5rem;align-items:center;padding:.5rem;border-radius:8px;background:${i===correctIdx?'rgba(34,211,160,.15)':'var(--bg)'};border:2px solid ${i===correctIdx?'var(--green)':'var(--border)'}">
        <span style="font-weight:800;font-family:var(--mono)">${'ABCD'[i]}</span>
        <span>${o||'(bo\'sh)'}</span>
        ${i===correctIdx?'<span style="margin-left:auto;color:var(--green)">âœ“</span>':''}
      </div>`).join('')}
    </div>`;
}

function saveQuestion() {
  const text = document.getElementById('mq-text').value.trim();
  if (!text) { toast("Savol matni kiriting", 'err'); qwizGo(1); return; }
  const rows = [...document.querySelectorAll('#mq-opts .option-edit-row')];
  const opts = rows.map(r => r.querySelector('.option-edit-input').value.trim()).filter(Boolean);
  if (opts.length < 2) { toast("Kamida 2 ta variant kiriting", 'err'); qwizGo(2); return; }
  const correctRow = rows.find(r => r.querySelector('.correct-toggle').classList.contains('active'));
  const correctOpt = correctRow ? correctRow.querySelector('.option-edit-input').value.trim() : '';
  const correct = opts.indexOf(correctOpt);
  if (correct === -1) { toast("To'g'ri javobni belgilang", 'err'); qwizGo(2); return; }
  
  const q = {
    id: editingQId || Date.now()+'',
    text, opts, correct,
    img: imgData || null,
    tag: document.getElementById('mq-tag').value.trim()
  };
  if (editingQId) {
    const i = DB.questions.findIndex(x => x.id === editingQId);
    DB.questions[i] = q;
  } else {
    DB.questions.push(q);
  }
  dbSave();
  closeOv('ov-question');
  toast("Savol saqlandi âœ“", 'ok');
  renderTQuestions();
}

function deleteQ(id) {
  if (!confirm("Savol o'chirilsinmi?")) return;
  DB.questions = DB.questions.filter(q => q.id !== id);
  DB.tests.forEach(t => t.qids = t.qids.filter(qid => qid !== id));
  if (DB.dailyTask) DB.dailyTask.qids = (DB.dailyTask.qids||[]).filter(qid => qid !== id);
  dbSave();
  toast("O'chirildi", 'ok');
  renderTQuestions();
}

// Image upload
document.getElementById('mq-img-file').addEventListener('change', function() {
  if (!this.files[0]) return;
  const r = new FileReader();
  r.onload = e => {
    imgData = e.target.result;
    const p = document.getElementById('mq-img-preview');
    p.src = e.target.result; p.style.display = 'block';
  };
  r.readAsDataURL(this.files[0]);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCreateTest() {
  const picker = document.getElementById('mt-qpicker');
  picker.innerHTML = DB.questions.length === 0
    ? `<div style="padding:1rem;color:var(--muted2);font-size:.85rem">Avval savol qo'shing</div>`
    : DB.questions.map(q => `
        <div class="q-picker-item" id="mtp_${q.id}" onclick="toggleMTP('${q.id}')">
          <div class="pick-check"></div>
          <div><div class="q-picker-text">${q.text.substring(0,70)}</div><div class="q-picker-tag">${q.tag||'Umumiy'} Â· To'g'ri: ${'ABCD'[q.correct]}</div></div>
        </div>`).join('');
  document.getElementById('mt-name').value = '';
  document.getElementById('mt-time').value = '0';
  openOv('ov-test');
}

function toggleMTP(id) {
  const el = document.getElementById('mtp_' + id);
  const p = el.classList.toggle('picked');
  el.querySelector('.pick-check').textContent = p ? 'âœ“' : '';
}

function saveTest() {
  const title = document.getElementById('mt-name').value.trim();
  if (!title) { toast("Test nomini kiriting", 'err'); return; }
  const time = parseInt(document.getElementById('mt-time').value) || 0;
  const qids = [...document.querySelectorAll('#mt-qpicker .q-picker-item.picked')].map(el => el.id.replace('mtp_',''));
  if (!qids.length) { toast("Kamida 1 ta savol tanlang", 'err'); return; }
  DB.tests.push({ id: Date.now()+'', title, qids, time });
  dbSave();
  closeOv('ov-test');
  toast("Test yaratildi âœ“", 'ok');
  renderTTests();
}

function deleteTest(id) {
  if (!confirm("Test o'chirilsinmi?")) return;
  DB.tests = DB.tests.filter(t => t.id !== id);
  dbSave();
  toast("O'chirildi", 'ok');
  renderTTests();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendTGMsg(text) {
  const {token, chatId} = DB.settings;
  if (!token || !chatId) return false;
  try {
    const r = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({chat_id: chatId, text, parse_mode:'HTML'})
    });
    const d = await r.json(); return d.ok;
  } catch(e) { return false; }
}

function sendTG(res) {
  const pct = Math.round(res.score/res.total*100);
  const e = pct>=80?'â­':pct>=60?'âœ…':'âš ï¸';
  sendTGMsg(`${e} <b>Yangi natija!</b>\n\nğŸ‘¤ <b>O'quvchi:</b> ${res.student}\nğŸ« <b>Sinf:</b> ${res.grade||'â€”'}\nğŸ“ <b>Topshiriq:</b> ${res.title}\nğŸ”¢ <b>Ball:</b> ${res.score}/${res.total} (${pct}%)\nğŸ“… <b>Sana:</b> ${res.date}\nğŸ· <b>Tur:</b> ${res.type==='daily'?'Kunlik mashq':'Test'}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (!DB.results.length) { toast("Natija yo'q", 'err'); return; }
  const bom = '\uFEFF';
  const h = 'O\'quvchi,Sinf,Topshiriq,Tur,Ball,Jami,Foiz,Sana\n';
  const rows = DB.results.map(r => `"${r.student}","${r.grade||''}","${r.title}","${r.type}",${r.score},${r.total},${Math.round(r.score/r.total*100)}%,"${r.date}"`).join('\n');
  const blob = new Blob([bom+h+rows], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'mathclass_natijalar.csv'; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openOv(id) { document.getElementById(id).classList.add('open'); }
function closeOv(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target === ov) ov.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast show ' + type;
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gradeBadge(s, t) {
  const p = s/t;
  return p >= .8 ? 'badge-green' : p >= .5 ? 'badge-yellow' : 'badge-red';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti() {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const particles = Array.from({length:100}, () => ({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height,
    r: Math.random()*6+4, d: Math.random()*100,
    color: ['#38bdf8','#22d3a0','#fbbf24','#f87171','#a78bfa'][Math.floor(Math.random()*5)],
    tilt: Math.random()*10-10, tiltAngle: 0, tiltAngleInc: Math.random()*.07+.05
  }));
  let frame = 0;
  const tick = () => {
    if (frame++ > 200) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p => {
      p.tiltAngle += p.tiltAngleInc; p.y += (Math.cos(p.d)+3+p.r/2)/2; p.tilt = Math.sin(p.tiltAngle)*15;
      if (p.y > canvas.height) { p.y = -20; p.x = Math.random()*canvas.width; }
      ctx.beginPath(); ctx.fillStyle = p.color; ctx.arc(p.x+p.tilt, p.y, p.r, 0, 2*Math.PI); ctx.fill();
    });
    requestAnimationFrame(tick);
  };
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO DATA (first run)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (!DB.questions.length) {
  DB.questions = [
    { id: 'q1', text: '7 Ã— 8 nechiga teng?', opts: ['48','56','54','64'], correct: 1, img: null, tag: 'Arifmetika' },
    { id: 'q2', text: '2x + 5 = 13 tenglamani yeching. x = ?', opts: ['3','4','5','6'], correct: 1, img: null, tag: 'Algebra' },
    { id: 'q3', text: 'Radiusi 5 bo\'lgan aylana yuzini toping (Ï€ â‰ˆ 3.14)', opts: ['78.5','31.4','15.7','25'], correct: 0, img: null, tag: 'Geometriya' },
    { id: 'q4', text: '200 ning 15 foizi qancha?', opts: ['25','30','35','40'], correct: 1, img: null, tag: 'Foizlar' },
    { id: 'q5', text: '144 ning kvadrat ildizi nechiga teng?', opts: ['11','12','13','14'], correct: 1, img: null, tag: 'Arifmetika' },
  ];
  DB.tests = [{ id: 't1', title: 'Boshlang\'ich test', qids: ['q1','q2','q3','q4','q5'], time: 10 }];
  DB.dailyTask = { title: 'Bugungi isitish mashqi', qids: ['q1','q5'] };
  dbSave();
}
</script>
</body>
</html>
